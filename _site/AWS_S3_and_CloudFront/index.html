<!DOCTYPE html>
<html>
  <head>
    <title>Setting up an HTTPS static site using AWS S3 and Cloudfront (and also Jekyll and s3_website) – Alexej Gossmann</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="For a while now I wanted to migrate my websites away from Github pages.
While Github provides an excellent free service, there are some limitations to its capabilities, and the longer I wait the harder (or the more inconvenient) it becomes to migrate away from gh-pages.
AWS S3 + CloudFront is a widely-used alternative that has been around for a long time.
Moreover, I was planning to get more familiar with AWS at all levels anyway.
So, it’s a great learning opportunity too.

" />
    <meta property="og:description" content="For a while now I wanted to migrate my websites away from Github pages.
While Github provides an excellent free service, there are some limitations to its capabilities, and the longer I wait the harder (or the more inconvenient) it becomes to migrate away from gh-pages.
AWS S3 + CloudFront is a widely-used alternative that has been around for a long time.
Moreover, I was planning to get more familiar with AWS at all levels anyway.
So, it’s a great learning opportunity too.

" />
    
    <meta name="author" content="Alexej Gossmann" />

    
    <meta property="og:title" content="Setting up an HTTPS static site using AWS S3 and Cloudfront (and also Jekyll and s3_website)" />
    <meta property="twitter:title" content="Setting up an HTTPS static site using AWS S3 and Cloudfront (and also Jekyll and s3_website)" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Alexej Gossmann - PhD student with focus on statistics, machine learning, and programming, among other things" href="/feed.xml" />

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->

    <!-- MathJax integration and configuration-->
    <!-- Use standard LaTeX delimiters and turn on equation numbering -->
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ["$","$"] ],
        displayMath: [ ["$$","$$"] ],
        processEscapes: true
      },
      TeX: {
        equationNumbers: { autoNumber: "AMS" },
        Macros: {
          subscript: ['_{#1}', 1],
          superscript: ['^{#1}', 1]
        }
      }
    });
    </script>
    <script type="text/javascript" async
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML-full">
    </script>
 </head>

  <body>
    <div class="wrapper-masthead">
      <header class="masthead clearfix">
        <a href="/" class="site-avatar"><img src="/images/avatar.png"></a>

        <div class="site-info">
          <h1 class="site-name"><a href="/">Alexej Gossmann</a></h1>
          <p class="site-description">PhD student with focus on statistics, machine learning, and programming, among other things</p>
        </div>

        <nav>
          <a href="/">/blog/</a>
          <a href="/publications">/publications/</a>
          <a href="/code">/code/</a>
          <a href="/about">/about/</a>
        </nav>
      </header>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>Setting up an HTTPS static site using AWS S3 and Cloudfront (and also Jekyll and s3_website)</h1>

  <div class="entry">
    <p>For a while now I wanted to migrate my websites away from Github pages.
While Github provides an excellent free service, there are some limitations to its capabilities, and the longer I wait the harder (or the more inconvenient) it becomes to migrate away from gh-pages.
AWS S3 + CloudFront is a widely-used alternative that has been around for a long time.
Moreover, I was planning to get more familiar with AWS at all levels anyway.
So, it’s a great learning opportunity too.</p>

<p>There are a <a href="https://medium.com/@esfoobar/setting-up-an-https-static-site-using-amazon-aws-7ab270c4e277">number</a> <a href="https://www.david-merrick.com/2017/05/24/moving-my-jekyll-website-from-github-pages-to-s3/">of</a> <a href="https://vickylai.com/verbose/hosting-your-static-site-with-aws-s3-route-53-and-cloudfront/">very</a> <a href="https://medium.com/@jameshamann/migrating-your-jekyll-website-to-aws-bc9582b3fbb2">helpful</a> <a href="https://blog.jpterry.com/howto/2016/02/02/secure-static-hosting-w-s3-cloudfront-acm.html">tutorials</a> online on how to set up an HTTPS static site using AWS S3 and CloudFront.
Of course, as always the case with blog articles, they may be outdated, incomplete, and generally not as trustworthy as <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/WebsiteHosting.html">the official AWS documentation on the topic</a>, which is pretty good too; but it is also somewhat fragmented and inconvenient to follow.
So I wrote my own summary to refer to in the future.</p>

<p><strong>tldr:</strong> Relevant AWS docs: <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/HostingWebsiteOnS3Setup.html">How to create a static website on AWS S3</a>; <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/website-hosting-custom-domain-walkthrough.html">How to use a custom domain with AWS S3</a>; <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/website-hosting-cloudfront-walkthrough.html">Setting up Amazon CloudFront</a>; <a href="https://docs.aws.amazon.com/acm/latest/userguide/gs-acm-request-public.html">SSL certificate instructions</a>.</p>

<h3 id="1-set-up-a-static-site-yet-without-cloudfront-and-without-https">1 Set up a static site, yet without CloudFront and without HTTPS</h3>

<p>First, we set up a static HTTP site without a custom domain on AWS S3:</p>

<ul>
  <li>Create a bucket named <code class="highlighter-rouge">example.com</code> (obviously replace <code class="highlighter-rouge">example.com</code> with your own domain).</li>
  <li>Follow the procedure given at <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/HostingWebsiteOnS3Setup.html">https://docs.aws.amazon.com/AmazonS3/latest/dev/HostingWebsiteOnS3Setup.html</a> to <em>enable website hosting</em> for the bucket, and to make it <em>publicly readable</em>; (optionally) if you want to understand the AWS bucket access policy language see <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev//access-policy-language-overview.html">https://docs.aws.amazon.com/AmazonS3/latest/dev//access-policy-language-overview.html</a>, and follow the links from there.</li>
  <li>Test the S3 website: Upload an <code class="highlighter-rouge">index.html</code> to the bucket (you can keep all options for the upload at their default values). Go to <a href="http://example.com.s3-website-us-east-1.amazonaws.com/">http://example.com.s3-website-us-east-1.amazonaws.com/</a> (where you need to replace <code class="highlighter-rouge">example.com</code> with the bucket name, and <code class="highlighter-rouge">us-east-1</code> with your bucket’s region), and see if the contents of <code class="highlighter-rouge">index.html</code> show up.</li>
</ul>

<p>Yay <img class="emoji" title=":laughing:" alt=":laughing:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f606.png" height="20" width="20"> we have a working website!! …without a custom domain or https <img class="emoji" title=":sweat_smile:" alt=":sweat_smile:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f605.png" height="20" width="20"></p>

<p><strong>The www subdomain:</strong> Now prepare another S3 bucket for the subdomain “www.example.com” to be later redirected to the root domain “example.com” (btw, if you so wish, <code class="highlighter-rouge">www.example.com</code> can be the main S3 bucket and the <code class="highlighter-rouge">example.com</code> bucket can be configured to redirect — just swap their roles in this entire writeup):</p>

<ul>
  <li>Create a bucket named <code class="highlighter-rouge">www.example.com</code> (all options can be left at their defaults; this bucket doesn’t need to be publicly readable).</li>
  <li>Configure <code class="highlighter-rouge">www.example.com</code> to redirect all requests to <code class="highlighter-rouge">example.com</code> following Step 2.3 from the AWS docs at <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/website-hosting-custom-domain-walkthrough.html">https://docs.aws.amazon.com/AmazonS3/latest/dev/website-hosting-custom-domain-walkthrough.html</a>.</li>
  <li>Test the endpoints for the redirect by going to <a href="http://www.example.com.s3-website-us-east-1.amazonaws.com/">http://www.example.com.s3-website-us-east-1.amazonaws.com/</a> (as before replace the bucket name and region accordingly).</li>
</ul>

<p><strong>Map the domain and subdomain to their S3 buckets:</strong></p>

<p>Amazon Route 53 is a service that maintains a mapping between the alias records and the IP of the bucket.
You need to follow Step 3 from the AWS docs at <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/website-hosting-custom-domain-walkthrough.html">https://docs.aws.amazon.com/AmazonS3/latest/dev/website-hosting-custom-domain-walkthrough.html</a>.</p>

<p><strong>Configuration with your domain name registrar:</strong></p>

<ul>
  <li>In AWS go to Route 53 -&gt; Hosted zones -&gt; example.com</li>
  <li>The NS (name servers) records that you see are what needs to be provided to the domain name registrar. For example, for GoDaddy I have to choose to use “custom nameservers” under the DNS settings for the domain, and then to input all (four in my case) of the URLs provided as values under the NS record.</li>
  <li>Your website should now appear under http://example.com (and http://www.example.com).</li>
</ul>

<p><img class="emoji" title=":smile:" alt=":smile:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f604.png" height="20" width="20"> So we have a website with a custom domain!! …though yet without CloudFront (so loading may be rather slow) and without HTTPS.</p>

<h4 id="optional-configure-an-iam-role-with-limited-access-permissions">Optional: Configure an IAM role with limited access permissions</h4>

<p>Now it seems a good idea to create a new user that has full read-write permission to the <code class="highlighter-rouge">example.com</code> bucket and full permission to CloudFront, but does not have any further AWS permissions.
A suitable IAM policy document can be found at: <a href="https://github.com/laurilehmijoki/s3_website/blob/master/additional-docs/setting-up-aws-credentials.md">https://github.com/laurilehmijoki/s3_website/blob/master/additional-docs/setting-up-aws-credentials.md</a>
Make sure to save the new user’s access key ID and secret access key somewhere in a private place.</p>

<h4 id="optional-use-jekyll-and-s3_website-to-generate-a-static-site-and-to-push-it-to-the-s3-bucket">Optional: Use Jekyll and s3_website to generate a static site and to push it to the S3 bucket</h4>

<p>Well, I typically use <a href="https://jekyllrb.com/">Jekyll</a> to make my static sites (because it’s awesome!).
The Ruby gem <a href="https://github.com/laurilehmijoki/s3_website"><code class="highlighter-rouge">s3_website</code></a> can be used to push the website to, or to synchronized it with the S3 bucket.
The <a href="https://github.com/laurilehmijoki/s3_website"><code class="highlighter-rouge">s3_website</code> documentation</a> is easy to follow.
I have found it convenient to use the <a href="https://github.com/bkeepers/dotenv"><code class="highlighter-rouge">dotenv</code> gem</a> to keep the access key ID and the secret access key of the user (that was just created) locally in a <code class="highlighter-rouge">.env</code> file (don’t commit/push it to github!!!)
At this point you may also choose to allow <code class="highlighter-rouge">s3_website</code> to set up CloudFront for the website to save some time later (though without the SSL certificate, which will still have to be added manually, see below).</p>

<h3 id="2-request-a-public-ssl-certificate">2 Request a public SSL certificate</h3>

<p>We need an SSL certificate to enable HTTPS for the custom domain when it is accessed through CloudFront.</p>

<p>Follow the AWS docs at <a href="https://docs.aws.amazon.com/acm/latest/userguide/gs-acm-request-public.html">https://docs.aws.amazon.com/acm/latest/userguide/gs-acm-request-public.html</a> to request an SSL certificate for your domain. Some important points:</p>
<ul>
  <li>Add <code class="highlighter-rouge">example.com</code> and <code class="highlighter-rouge">*.example.com</code> to the certificate.</li>
  <li>Use DNS validation (rather than email validation), whereby in the “pending validation” stage you can choose “Create record in Route 53” which saves time (since we have already configures Route 53 for this domain).</li>
</ul>

<p>I encountered one caveat in this process:</p>

<blockquote>
  <p>To use an ACM Certificate with CloudFront, you must request or import the certificate in the US East (N. Virginia) region.</p>
</blockquote>

<p>(from <a href="http://docs.aws.amazon.com/acm/latest/userguide/acm-services.html">http://docs.aws.amazon.com/acm/latest/userguide/acm-services.html</a>); i.e., change region to US East N. Virginia (top right corner within the AWS interface).</p>

<h3 id="3-create-a-cloudfront-distribution">3 Create a CloudFront distribution</h3>

<p>Follow these AWS docs to create a CloudFront distribution: <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/website-hosting-cloudfront-walkthrough.html">https://docs.aws.amazon.com/AmazonS3/latest/dev/website-hosting-cloudfront-walkthrough.html</a>; unless a CloudFront distribution was already created by <code class="highlighter-rouge">s3_website</code> (see one of the previous optional steps), in which case it needs to be merely edited (add the SSL certificate to it, and update “Alternate Domain Names” with <code class="highlighter-rouge">yourdomain.com</code> and <code class="highlighter-rouge">www.yourdomain.com</code> if necessary).</p>

<p>Notice the designated CloudFront distribution domain, which should look similar to vtrlj8ubh2k69.cloudfront.net. Once set up the website should appear under it.</p>

<p><strong>A few points I found noteworthy:</strong></p>

<ul>
  <li>One can choose to set HTTP to always redirect to HTTPS.</li>
  <li>Once issued, the SSL certificate can be selected from the drop down menu under “Custom SSL Certificates”.</li>
  <li>As pointed out in <a href="https://vickylai.com/verbose/hosting-your-static-site-with-aws-s3-route-53-and-cloudfront/">Vicky Lai’s blog post</a> the “Origin” column in the CloudFront Console should show the S3 bucket’s endpoint <code class="highlighter-rouge">example.com.s3-website.us-east-1.amazonaws.com</code>, and not the bucket name <code class="highlighter-rouge">example.com.s3.amazonaws.com</code> (btw <code class="highlighter-rouge">s3_website</code> does this correctly). Note that when setting up, the drop down menu offers only the bucket name to be picked rather the correct endpoint; so, don’t use the drop down menu; type it in yourself.<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup>
</li>
</ul>

<p><strong>Update A records in Route 53, and update the</strong> <code class="highlighter-rouge">s3_website</code> <strong>configs:</strong></p>

<ul>
  <li>In AWS go to Route 53 -&gt; Hosted zones -&gt; example.com</li>
  <li>For both A records, change the “Alias Target” from the S3 endpoint to the CloudFront distribution domain (i.e., something like <code class="highlighter-rouge">vtrlj8ubh2k69.cloudfront.net</code>).</li>
  <li>If you use <code class="highlighter-rouge">s3_website</code> check or set the <code class="highlighter-rouge">cloudfront_distribution_id</code> property in <code class="highlighter-rouge">s3_website.yml</code> to the correct distribution ID (something like <code class="highlighter-rouge">SY9Q4DHIOUG7A</code>)</li>
</ul>

<p>That’s it — the site should now be accessible under <code class="highlighter-rouge">https://example.com</code> and <code class="highlighter-rouge">https://www.example.com</code>. <img class="emoji" title=":tada:" alt=":tada:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f389.png" height="20" width="20"> <img class="emoji" title=":tada:" alt=":tada:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f389.png" height="20" width="20"> <img class="emoji" title=":tada:" alt=":tada:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f389.png" height="20" width="20"></p>

<hr>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>It is not exactly clear to me what difference it makes to set the “Origin” to <code class="highlighter-rouge">example.com.s3.amazonaws.com</code> vs <code class="highlighter-rouge">example.com.s3-website.us-east-1.amazonaws.com</code>. However, it solved one of my issues. At first I set the “Origin” value to the bucket name, similar to <code class="highlighter-rouge">example.com.s3.amazonaws.com</code>, since that is what was offered by the drop down menu in CloudFront. The landing page of the website was working just fine under the custom domain. However, when I navigated to subdirectories in my domain, similar to <code class="highlighter-rouge">example.com/about/</code>, the server did not seem to understand that it needed to look for the <code class="highlighter-rouge">index.html</code> within the <code class="highlighter-rouge">about</code> directory, and produced an error. Once I edited the “Origin” record to the S3 bucket endpoint, similar to <code class="highlighter-rouge">example.com.s3-website.us-east-1.amazonaws.com</code>, all pages of the website started to display perfectly fine. <a href="#fnref:1" class="reversefootnote">↩</a></p>
    </li>
  </ol>
</div>

  </div>

  <div class="date">
    Written on July 27, 2018
  </div>

  <div class="date">
    Tags:
    
    <a href="/tag/AWS">#AWS</a>
    
    <a href="/tag/cloud">#cloud</a>
    
  </div>

  
<div class="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">

	    var disqus_shortname = 'agisga';

	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();

	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
</div>

</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          
<a href="mailto:alexej.go@gmail.com"><i class="svg-icon email"></i></a>
<a href="https://www.facebook.com/alexej.yexela"><i class="svg-icon facebook"></i></a>

<a href="https://github.com/agisga"><i class="svg-icon github"></i></a>

<a href="https://www.linkedin.com/in/alexejgossmann"><i class="svg-icon linkedin"></i></a>

<a href="/feed.xml"><i class="svg-icon rss"></i></a>




        </footer>
      </div>
    </div>

    
	<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-94080131-1', 'auto');
		ga('send', 'pageview', {
		  'page': '/AWS_S3_and_CloudFront/',
		  'title': 'Setting up an HTTPS static site using AWS S3 and Cloudfront (and also Jekyll and s3_website)'
		});
	</script>
	<!-- End Google Analytics -->


  </body>
</html>
