<!DOCTYPE html>
<html>
  <head>
    <title>A rudimentary first linear mixed model fit – Alexej Gossmann</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="During the last two weeks I made some progress on my Google Summer of Code project.
The Ruby gem is now capable of fitting linear mixed models. In this short blog post I want to give an example, and compare the results I get in Ruby to those obtained by lme4 in R.

" />
    <meta property="og:description" content="During the last two weeks I made some progress on my Google Summer of Code project.
The Ruby gem is now capable of fitting linear mixed models. In this short blog post I want to give an example, and compare the results I get in Ruby to those obtained by lme4 in R.

" />
    
    <meta name="author" content="Alexej Gossmann" />

    
    <meta property="og:title" content="A rudimentary first linear mixed model fit" />
    <meta property="twitter:title" content="A rudimentary first linear mixed model fit" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Alexej Gossmann - PhD student with focus on statistics, machine learning, and programming, among other things" href="/feed.xml" />

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->

    <!-- MathJax integration and configuration-->
    <!-- Use standard LaTeX delimiters and turn on equation numbering -->
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ["$","$"] ],
        displayMath: [ ["$$","$$"] ],
        processEscapes: true
      },
      TeX: {
        equationNumbers: { autoNumber: "AMS" },
        Macros: {
          subscript: ['_{#1}', 1],
          superscript: ['^{#1}', 1]
        }
      }
    });
    </script>
    <script type="text/javascript" async
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML-full">
    </script>
 </head>

  <body>
    <div class="wrapper-masthead">
      <header class="masthead clearfix">
        <a href="/" class="site-avatar"><img src="/images/avatar.png" /></a>

        <div class="site-info">
          <h1 class="site-name"><a href="/">Alexej Gossmann</a></h1>
          <p class="site-description">PhD student with focus on statistics, machine learning, and programming, among other things</p>
        </div>

        <nav>
          <a href="/">/blog/</a>
          <a href="/publications">/publications/</a>
          <a href="/code">/code/</a>
          <a href="/about">/about/</a>
        </nav>
      </header>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>A rudimentary first linear mixed model fit</h1>

  <div class="entry">
    <p>During the last two weeks I made some progress on my <a href="https://github.com/agisga/MixedModels">Google Summer of Code project</a>.
The Ruby gem is now capable of fitting linear mixed models. In this short blog post I want to give an example, and compare the results I get in Ruby to those obtained by <code class="highlighter-rouge">lme4</code> in R.</p>

<h1 id="lmm-mathematical-basics">LMM Mathematical Basics</h1>

<p>Mathematically, a <a href="http://cran.r-project.org/web/packages/lme4/vignettes/lmer.pdf">linear mixed model</a> has the general form</p>

<script type="math/tex; mode=display">(y | b = \hat{b}) \sim \mathrm{N}(X\beta + Z\hat{b} + o, \sigma^2 W^{-1}), \mathrm{\,with\,} b \sim \mathrm{N}(0, \Sigma\subscript{\theta}),</script>

<p>where $y\in\mathbb{R}^n$ and $b\in\mathbb{R}^q$ are random vectors (response and random effects), $\beta\in\mathbb{R}^p$ is the vector of fixed effects, $o\in\mathbb{R}^n$ is a vector of known prior offset terms, $W\in\mathbb{R}^{n\times n}$ is a diagonal matrix of known prior weights. The random effects covariance matrix $\Sigma\subscript{\theta}\in\mathbb{R}^{q\times q}$ depends on the variance component parameter vector $\theta\in\mathbb{R}^l$.
Additionally, via the Cholesky decomposition we write</p>

<script type="math/tex; mode=display">\Sigma\subscript{\theta} = \sigma^2 \Lambda\subscript{\theta} \Lambda\subscript{\theta}^T,</script>

<p>where $\Lambda\subscript{\theta}$ is a lower triangular matrix, which is parametrized by $\theta$ in a way that is known a priori.</p>

<p>The goal of the model fitting process is to find parameter estimates $\hat{\theta}$, $\hat{\beta}$ and $\hat{b}$ that fit the observed data best. Then the LMM fit can be used for prediction and inference.</p>

<h1 id="model-fit-example">Model Fit Example</h1>

<p>The only currently available user interface is rudimentary. It requires the user to set up the design matrix $X$, the random effects model matrix $Z$, a <code class="highlighter-rouge">Proc</code> that generates a $\Lambda\subscript{\theta}$ matrix from a $\theta$ input, etc. by hand, before calling <code class="highlighter-rouge">LMM#initialize</code>. On the bright side, this adds a lot of flexibility to the model specification. In the future, I will write a more user-friendly R-like method <code class="highlighter-rouge">LMM#from_formula</code>.</p>

<h2 id="the-data">The Data</h2>

<p>Now, let’s look at the simulated data that I use to test the implemented method.</p>

<p>I generate a 50x2 design matrix $X$ with one column of ones (for the intercept) and one column of numbers 1,2,3,…,50. The data is divided into five groups of equal size (consecutive blocks of 10 rows of $X$). Each of these groups has its own random intercept and random slope. Thus, the random effects model matrix $Z$ is of size 50x10, and has the form</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 1  0 0  0 ...
1 2  0 0  0 ...
   ....
1 10 0 0  0 ...
0 0  1 11 0 ...
0 0  1 12 0 ...
   ....
0 0  1 20 0 ...
   ....
</code></pre></div></div>

<p>and $\Lambda\subscript{\theta}$ is 10x10 block-diagonal with five square blocks of the form <code class="highlighter-rouge">[ [theta[0], 0], [theta[1], theta[2] ]</code>.</p>

<p>The random effects <code class="highlighter-rouge">b</code> are generated from the multivariate distribution with mean 0 and covariance matrix <code class="highlighter-rouge">[ [1, 0.5], [0.5, 1] ]</code>, and 50 random error terms <code class="highlighter-rouge">epsilon</code> are generated from the standard normal distribution. Both, the fixed intercept and slope are set to be equal to one.</p>

<p>Finally I generate the response vector <code class="highlighter-rouge">y</code> as</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="nf">dot</span> <span class="n">beta</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">z</span><span class="p">.</span><span class="nf">dot</span> <span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">epsilon</span>
</code></pre></div></div>

<h2 id="results">Results</h2>

<p>The model fit can be performed with <a href="https://github.com/agisga/MixedModels"><code class="highlighter-rouge">MixedModels</code></a> in Ruby via:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model_fit</span> <span class="o">=</span> <span class="no">LMM</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">x: </span><span class="n">x</span><span class="p">,</span> <span class="ss">y: </span><span class="n">y</span><span class="p">,</span> <span class="ss">zt: </span><span class="n">z</span><span class="p">.</span><span class="nf">transpose</span><span class="p">,</span> <span class="ss">lambdat: </span><span class="n">lambdat</span><span class="p">,</span> 
                    <span class="ss">start_point: </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="ss">lower_bound: </span><span class="no">Array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="no">Float</span><span class="o">::</span><span class="no">INFINITY</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                    <span class="o">&amp;</span><span class="n">parametrization</span><span class="p">)</span> 
</code></pre></div></div>

<p>My entire Ruby code for this example can be found on github <a href="https://github.com/agisga/MixedModels/blob/master/examples/LMM.rb">here</a>.</p>

<p>Behind the scenes, <code class="highlighter-rouge">LMM#initialize</code> essentially performs the following three steps:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># (1) Create the data structure in a LMMData object</span>
<span class="vi">@model_data</span> <span class="o">=</span> <span class="no">LMMData</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">x: </span><span class="n">x</span><span class="p">,</span> <span class="ss">y: </span><span class="n">y</span><span class="p">,</span> <span class="ss">zt: </span><span class="n">zt</span><span class="p">,</span> <span class="ss">lambdat: </span><span class="n">lambdat</span><span class="p">,</span> 
                          <span class="ss">weights: </span><span class="n">weights</span><span class="p">,</span> <span class="ss">offset: </span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">thfun</span><span class="p">)</span>

<span class="c1"># (2) Set up the profiled deviance/REML function</span>
<span class="vi">@dev_fun</span> <span class="o">=</span> <span class="no">MixedModels</span><span class="o">::</span><span class="n">mk_lmm_dev_fun</span><span class="p">(</span><span class="vi">@model_data</span><span class="p">,</span> <span class="vi">@reml</span><span class="p">)</span>

<span class="c1"># (3) Optimize the deviance/REML</span>
<span class="vi">@optimization_result</span> <span class="o">=</span> <span class="no">MixedModels</span><span class="o">::</span><span class="no">NelderMead</span><span class="p">.</span><span class="nf">minimize</span><span class="p">(</span><span class="ss">start_point: </span><span class="n">start_point</span><span class="p">,</span> 
                                                        <span class="ss">lower_bound: </span><span class="n">lower_bound</span><span class="p">,</span> 
                                                        <span class="ss">upper_bound: </span><span class="n">upper_bound</span><span class="p">,</span>
                                                        <span class="ss">epsilon: </span><span class="n">epsilon</span><span class="p">,</span> 
                                                        <span class="ss">max_iterations: </span><span class="n">max_iterations</span><span class="p">,</span>
                                                        <span class="o">&amp;</span><span class="n">dev_fun</span><span class="p">)</span>
</code></pre></div></div>

<p>We can fit a linear mixed model in R to the same matrix and vector data with:</p>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dat.frm</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.data.frame</span><span class="p">(</span><span class="n">cbind</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">[,</span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">,</span><span class="n">each</span><span class="o">=</span><span class="m">10</span><span class="p">)))</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">dat.frm</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"y"</span><span class="p">,</span><span class="w"> </span><span class="s2">"x"</span><span class="p">,</span><span class="w"> </span><span class="s2">"grp"</span><span class="p">)</span><span class="w">
</span><span class="n">lmer.fit</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lmer</span><span class="p">(</span><span class="n">y</span><span class="o">~</span><span class="n">x</span><span class="o">+</span><span class="p">(</span><span class="n">x</span><span class="o">|</span><span class="n">grp</span><span class="p">),</span><span class="w"> </span><span class="n">dat.frm</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Let’s look at some of the results.</p>

<p>In Ruby:</p>

<p><img src="/images/rudimentary-lmm-fit-ruby.png?raw=true" alt="Rudimentary-LMM-fit-Ruby PNG" title="rudimentary-lmm-fit-ruby.png" /></p>

<p>And in R:</p>

<p><img src="/images/rudimentary-lmm-fit-R.png?raw=true" alt="Rudimentary-LMM-fit-R PNG" title="rudimentary-lmm-fit-R.png" /></p>

<p>We see that all values agree between Ruby and R up to at least one digit behind the floating point (these values are the REML criterion, fixed effects estimates, random effects standard deviations and correlation, and residual variance and standard deviation, to be more precise). The slight differences are probably due to different optimization routines.</p>

  </div>

  <div class="date">
    Written on June  4, 2015
  </div>

  <div class="date">
    Tags:
    
    <a href="/tag/ruby">#ruby</a>
    
    <a href="/tag/mixed_models">#mixed_models</a>
    
    <a href="/tag/regression">#regression</a>
    
    <a href="/tag/LMM">#LMM</a>
    
  </div>

  
<div class="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">

	    var disqus_shortname = 'agisga';

	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();

	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          
<a href="mailto:alexej.go@gmail.com"><i class="svg-icon email"></i></a>
<a href="https://www.facebook.com/alexej.yexela"><i class="svg-icon facebook"></i></a>

<a href="https://github.com/agisga"><i class="svg-icon github"></i></a>

<a href="https://www.linkedin.com/in/alexejgossmann"><i class="svg-icon linkedin"></i></a>

<a href="/feed.xml"><i class="svg-icon rss"></i></a>




        </footer>
      </div>
    </div>

    
	<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-94080131-1', 'auto');
		ga('send', 'pageview', {
		  'page': '/First-linear-mixed-model-fit/',
		  'title': 'A rudimentary first linear mixed model fit'
		});
	</script>
	<!-- End Google Analytics -->


  </body>
</html>
